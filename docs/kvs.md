# KVS

## Admin interface

REST interface for the configuration of the system.

| Command          | REST                          |
| ---------------- | ----------------------------- |
| Add app          | `POST /apps`                  |
| Delete app       | `DELETE /apps/{appkey}`       |
| Add platform     | `POST /platforms`             |
| Delete platform  | `DELETE /platforms/{name}`    |
| Platform load    | `POST /platforms/{name}/load` |
| Key availability | `POST /platforms/{name}/key`  |


### Add app

REST command: `POST /apps`

The body contains a JSON with the following objects:

- `appInfo`: structure defined in `ApplicationList` ETSI GS MEC 016
- `platforms`: array of structures, with at least one value, specifying where the app can be deployed and containing the following fields:
  - `type`: one of the platform types supported, e.g., `openwhisk`
  - `blacklist`: array of platform names where the app _cannot_ be deployed; if empty, then the app can be deployed on any platform according to the whitelist (see next field)
  - `whitelist`: array of platform names where the app _can_ be deployed; if empty, then the app can be deployed on any platform except those specified in the blacklist (see previous field)
  - `deployInfo`: structure containing all the data needed to deploy this app on this platform, depending on the value of the `type` field

Effect: upon successful execution of the command the new app is made visible to the device apps via the ETSI MEC Mx2 application look-up procedure.

### Delete app

REST command: `DELETE /apps/{appkey}`

The `{appkey}` is a concatenation of the following `appInfo` fields, which uniquely identify an app in the system:

- `appDId`
- `appName`
- `appProvider`
- `appSoftVersion`
- `appDVersion`

Effect: upon successful execution of the command the removed app is not returned to device apps via ETSI MEC Mx2 application look-up procedures. Active contexts are not affected by this procedure.

### Add platform

REST command: `POST /platforms`

The body contains a JSON structure with the following fields:

- `name`: the name of the platform, which is unique in the system
- `type`: one of the platform types supported, e.g., `openwhisk`
- `credentials` to deploys apps on this platform
- `endpointMgmt` to configure this platform, in particular to deploy or delete apps
- `endpointApps` end-point of the platform that will returned to the device apps in the `referenceURI` field of the `AppContext` defined in ETSI GS MEC 016

Effect: upon successful execution of the command the new platform is made available to the MEO for assignment of new application contexts or migration of active application contexts.

### Delete platform

REST command: `DELETE /platforms/{name}`

Effect: upon successful execution of the command the following actions occur:

1. the MEO will not assign new application contexts to the removed platform 
2. all the active application contexts assigned to the removed platform are migrated to another platform, and the respective device apps are notified of the new `referenceURI` via notification events generated by the LCMP

## Telemetry interface

REST interface for monitoring the status of the platforms.

### Platform load

REST command: `POST /platforms/{name}/load`

The body contains a JSON structure with a single field `value` indicating the a [0,1] normalized real value of the load of the platform `{name}` (0: the platform is idle; 1: the platform is fully loaded).

### Key availability

REST command: `POST /platforms/{name}/key`

The body contains a JSON structure with a single field `value` indicating the a [0,1] normalized real value of the availability of QKD secret material at the key manager used by the platform `{name}` (0: the key manager cannot provide the MEC apps with new keys; 1: the maximum amount of keys are available for MEC apps at the key manager).

## Data model

The KVS has an in-memory storage of the following data, which are made available to the other components via an internal interface.

### Core data

- applications
  - type: list
  - key: `apps`
  - value: JSON-encoded string used in the _add app_ command above
- platforms
  - type: vector
  - key: `platforms`
  - value: JSON-encoded string used in the _add platform_ command above
- contexts
  - type: list
  - key: `contexts:{platformName}`
  - value: JSON-encoded string of application contexts assigned to the platform `{platformName}`, following the definition of `AppContext` in ETSI GS MEC 016

### Counters

The counters below can be used by the components to cache data.

- applications' operations counter:
  - type: string
  - key: `apps:operations`
  - value: string representation of an integer number incremented at each operation on the applications
- platforms' operations counter:
  - type: string
  - key: `platforms:operations`
  - value: string representation of an integer number incremented at each operation on the platforms
- contexts' operations counter:
  - type: string
  - key: `contexts:operations`
  - value: string representation of an integer number incremented at each operation on the contexts

### Telemetry

Telemetry data of the platforms. The length of each vector below is the same as the `platforms` vector.

- telemetry load values:
  - type: vector
  - key: `telemetry:platforms:load`
  - value: string representation of a real value representing the last load value reported for the platform of matching index in `platforms`
- telemetry key availability values:
  - type: vector
  - key: `telemetry:platforms:key`
  - value: string representation of a real value representing the last key availability value reported for the platform of matching index in `platforms`